{% extends "base.html" %}

{% block title %}Solver{% endblock %}

{% block content %}

    <section>

            <div>
                <form name = "config" id = "patients" method = "post">
                    <label for = "n_patients">Número de pacientes</label>
                    <input name = "n_patients" id = "n_patients" type = "number" value = "{{n_patients}}">

                    <label for = "p_uti">Nº UTI</label>
                    <input name = "p_uti" id = "n_uti" type = "number" value = "{{n_uti}}">

                    <label for = "p_utsi">Nº UTSI</label>
                    <input name = "p_utsi" id = "n_utsi" type = "number" value = "{{n_utsi}}">

                    <label for = "p_utp">Nº UTP</label>
                    <input name = "p_utp" id = "n_utp" type = "number" value = "{{n_utp}}">

                </form>

            </div>

    </section>

    <section>

        <div>

            <div>
                <h4></h4>
            </div>
            <h4>Nome do paciente</h4>
            <h4>Probabilidade de Sobrevivência</h4>
            <h4>Prioridade: UTI</h4>
            <h4>Prioridade: UTSI</h4>
            <h4>Prioridade: UTP</h4>

        </div>

        {% if patients %}
        <form name = "patients" method = "post">

            <input name = "total_patients" type = "hidden" value = "{{n_patients}}">
            <input name = "beds_uti" type = "hidden" value = "{{n_uti}}">
            <input name = "beds_utsi" type = "hidden" value = "{{n_utsi}}">
            <input name = "beds_utp" type = "hidden" value = "{{n_utp}}">

            {% for i, patient in enumerate( patients ) %}

            <div>

                <div>
                    <h4>{{ i + 1 }}</h4>
                </div>
                <input name = "name_{{ i + 1 }}" type = "text" value = "{{ patient.name }}">
                <input name = "surviving_chance{{ i + 1 }}" type = "number" value = "{{ patient.surviving_chance }}">
                <select id = "select_uti" name = "select_uti_{{ i + 1 }}">

                    <option value="0"></option>
                    {% if ranges is not none %}
                        {% for i in range( 5, 0, -1) %}
                            {% if patient.uti_chance == i %}
                                <option value="{{i}}" selected>{{ ranges[ i ] }}</option>
                            {% else %}
                                <option value="{{i}}">{{ ranges[ i ] }}</option>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <option value="5">Muito alta</option>
                        <option value="4">Alta</option>
                        <option value="3">Média</option>
                        <option value="2">Baixa</option>
                        <option value="1">Muito Baixa</option>
                    {% endif %}

                </select>

                <select id = "select_utsi" name = "select_utsi_{{ i + 1 }}">

                    <option value="0"></option>
                    {% if ranges is not none %}
                        {% for i in range( 5, 0, -1) %}
                            {% if patient.uti_chance == i %}
                                <option value="{{i}}" selected>{{ ranges[ i ] }}</option>
                            {% else %}
                                <option value="{{i}}">{{ ranges[ i ] }}</option>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <option value="5">Muito alta</option>
                        <option value="4">Alta</option>
                        <option value="3">Média</option>
                        <option value="2">Baixa</option>
                        <option value="1">Muito Baixa</option>
                    {% endif %}

                </select>

                <select id = "select_utp" name = "select_utp_{{ i + 1 }}">

                    <option value="0"></option>
                    {% if ranges is not none %}
                        {% for i in range( 5, 0, -1) %}
                            {% if patient.uti_chance == i %}
                                <option value="{{i}}" selected>{{ ranges[ i ] }}</option>
                            {% else %}
                                <option value="{{i}}">{{ ranges[ i ] }}</option>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <option value="5">Muito alta</option>
                        <option value="4">Alta</option>
                        <option value="3">Média</option>
                        <option value="2">Baixa</option>
                        <option value="1">Muito Baixa</option>
                    {% endif %}

                </select>
    
            </div>

            {% endfor %}


            <input name = "suggestion" type = "hidden" value = "suggestion">
            <input type = "submit" id = "suggestion" value = "Gerar sugestões">

        </form>
        {% endif %}

    </section>

    <section>

        <form name = "gen" method = "post">

            <label for = "int_uti">Nº UTI</label>
            <input name = "int_uti" id = "int_uti" type = "number" value = "0">

            <label for = "int_utsi">Nº UTSI</label>
            <input name = "int_utsi" id = "int_utsi" type = "number" value = "0">

            <label for = "int_utp">Nº UTP</label>
            <input name = "int_utp" id = "int_utp" type = "number" value = "0">

            <input name = "instances" type = "hidden" value = "instances">

            <input type = "submit" id = "submit" value = "Gerar instâncias">
            
        </form>

    </section>

    <script>

        const submitForm = function( event ){
            if ( event.key === "Enter" ){
                patients.submit()
            }
        }
        
        const patients = document.querySelector( "#patients" )
        patients.addEventListener( "keydown", submitForm )
        patients.addEventListener( "change", function( event ){

            if ( Number( patients.firstChild.textContent ) < 0 ){
                patients.firstChild.textContent = 0
                return
            }
            patients.submit()
        })

        const submits = document.querySelectorAll( "#submit" )

        for ( const sub of submits ){
            sub.addEventListener( "click", function(){
                const { config, patients, gen } = document.forms

                fetch( config.action, {
                    method: config.method,
                    header: { "content-type": config.enctype },
                    body: new FormData( config )
                } )

                sub.submit()
            } )
        }

        document.addEventListener( "keydown", function( event ){
            if ( event.key === "Enter" ){
                event.preventDefault()
            }
        } )

    </script>

{% endblock %}